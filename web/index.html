<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>VenomMaps — Simple UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">VenomMaps (USA)</div>
      <input id="search" class="search" placeholder="Search by common or scientific name…" autocomplete="off" />

    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="section-title">Results</div>
        <ul id="results" class="results"></ul>
        <div id="hint" class="hint">Type to search e.g. “cottonmouth”, “timber rattlesnake”...</div>

        <div class="section-title" style="margin-top:16px; display:flex; align-items:center; justify-content:space-between;">
          <label><input id="nearby-toggle" type="checkbox"> Nearby (in view)</label>
        </div>
        <ul id="nearby" class="results nearby" style="display:none"></ul>
        <div id="nearby-hint" class="hint" style="display:none">Pan/zoom the map to update.</div>

        <div class="section-title">Sightings</div>
        <div style="display:flex; align-items:center; gap:8px; margin: 6px 2px;">
          <label><input id="sightings-toggle" type="checkbox"> Show sightings</label>
          <span id="sightings-count" class="hint" style="margin-left:auto;"></span>
        </div>
        <label style="display:flex; align-items:center; gap:8px; margin: 6px 2px;">
          <input id="heat-toggle" type="checkbox"> Historical heat (all records)
          <button id="heat-info-btn" title="What is this?" style="margin-left:auto; border:none; background:#334155; color:#e2e8f0; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-weight:600; cursor:pointer;">i</button>
        </label>
        <div class="chips">
          <button class="chip active" data-days="all">All</button>
          <button class="chip" data-days="7">7d</button>
          <button class="chip" data-days="30">30d</button>
          <button class="chip" data-days="90">90d</button>
          <button class="chip" data-days="365">1y</button>
        </div>

        <div class="section-title">
          <span>Legend (selected species)</span>
          <button id="clear-selected" class="clear-btn" title="Clear all">Clear</button>
        </div>
        <ul id="legend" class="results selected-list"></ul>

        <div class="performance-section">
          <div class="section-title">Performance</div>
          <label>
            <input id="defer-ranges" type="checkbox" checked> Defer ranges while panning
          </label>
        </div>
      </aside>

      <main id="map"></main>
    </div>

    <div id="heat-info-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#0f172a; color:#e2e8f0; max-width:720px; width:90%; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.4); overflow:hidden;">
        <div style="padding:14px 16px; border-bottom:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-weight:600; font-size:16px;">Historical heat map</div>
          <button id="heat-info-close" style="border:none; background:transparent; color:#94a3b8; font-size:18px; cursor:pointer;">✕</button>
        </div>
        <div style="padding:16px; line-height:1.5; font-size:14px;">
          <p style="margin:0 0 10px 0;">This layer is a smoothed density map built from all historical sighting points. Each point adds a small circular bump in <em>screen pixels</em>; where many bumps overlap, the map looks hotter. This is essentially a kernel density estimate (KDE).</p>
          <pre style="white-space:pre-wrap; background:#111827; color:#e5e7eb; padding:12px; border-radius:6px; overflow:auto;"><code>Value(x) ≈ Σ w_i · K(||x − x_i|| / r)
K: radial kernel (circular)
r: radius in pixels (≈18px with blur)
w_i: point weight (intensity)</code></pre>
          <p style="margin:10px 0 6px 0;">Data and weights:</p>
          <ul style="margin:0 0 12px 18px; padding:0;">
            <li>Input file: <code>web/data/heat_all_r6.geojson</code> with Point features.</li>
            <li>Each feature becomes <code>[lat, lng, intensity]</code> for Leaflet.heat.</li>
            <li>Intensity is <strong>log‑compressed</strong> so dense spots don’t dominate.</li>
          </ul>
          <pre style="white-space:pre-wrap; background:#111827; color:#e5e7eb; padding:12px; border-radius:6px; overflow:auto;"><code>// map.js (excerpt)
const features = geo.features;
const step = features.length > 50000 ? Math.ceil(features.length / 50000) : 1; // downsample
for (let i = 0; i < features.length; i += step) {
  const f = features[i];
  if (!f || f.geometry?.type !== 'Point') continue;
  const [lng, lat] = f.geometry.coordinates;
  const count = (f.properties && typeof f.properties.count === 'number') ? f.properties.count : 1;
  const intensity = Math.max(0.2, Math.min(1, Math.log(1 + count) / 3));
  points.push([lat, lng, intensity]); // [lat, lng, weight]
}
L.heatLayer(points, {
  radius: 18,
  blur: 15,
  maxZoom: 11,
  minOpacity: 0.25,
  gradient: { 0.2:'#1e3a8a', 0.4:'#2563eb', 0.6:'#f59e0b', 0.8:'#ef4444', 1.0:'#dc2626' }
});</code></pre>
          <ul style="margin:12px 0 0 18px; padding:0;">
            <li>Downsampling preserves hotspot shape; we can rescale intensity if exact totals matter.</li>
            <li>Pixel radius means smoothing adapts with zoom (coarser out, finer in).</li>
            <li>Global view: species selection and time chips don’t affect this layer.</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script type="module">
      // Always use dark theme
      document.documentElement.setAttribute('data-theme', 'dark');
      
      import { attachSearch, loadCommon, attachNearby, attachSelectedPanel, onSelectionChange, selectAllSpecies } from './main.js';
      import { initMap, setSelection, onMapMove, getViewBounds, getMap, setDeferRanges } from './map.js';
      import { initSightings, setSightingsVisible, setRecencyDays } from './sightings.js';

      await loadCommon();
      await initMap();

      initSightings(getMap());

      attachSearch();
      attachNearby({ onMove: onMapMove, getBounds: getViewBounds });
      attachSelectedPanel();
      onSelectionChange(setSelection);

      selectAllSpecies();

      const toggle = document.getElementById('sightings-toggle');
      toggle.addEventListener('change', () => setSightingsVisible(toggle.checked));



      const defer = document.getElementById('defer-ranges');
      defer.addEventListener('change', () => setDeferRanges(defer.checked));

      const heatToggle = document.getElementById('heat-toggle');
      heatToggle.addEventListener('change', async () => {
        const m = getMap();
        const { toggleHeatLayer } = await import('./map.js');
        toggleHeatLayer(heatToggle.checked, m);
      });

      const heatInfoBtn = document.getElementById('heat-info-btn');
      const heatInfoModal = document.getElementById('heat-info-modal');
      const heatInfoClose = document.getElementById('heat-info-close');
      if (heatInfoBtn && heatInfoModal && heatInfoClose) {
        heatInfoBtn.addEventListener('click', () => { heatInfoModal.style.display = 'flex'; });
        heatInfoClose.addEventListener('click', () => { heatInfoModal.style.display = 'none'; });
        heatInfoModal.addEventListener('click', (e) => { if (e.target === heatInfoModal) heatInfoModal.style.display = 'none'; });
      }


      // Chip active states
      for (const btn of document.querySelectorAll('.chip')) {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          const v = btn.dataset.days;
          setRecencyDays(v === 'all' ? null : parseInt(v, 10));
        });
      }
    </script>
  </body>
  </html>


