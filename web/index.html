<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>VenomMaps — Simple UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">VenomMaps (USA)</div>
      <input id="search" class="search" placeholder="Search by common or scientific name…" autocomplete="off" />

    </header>

    <div class="layout">
      <aside class="sidebar">
        <div class="section-title">Results</div>
        <ul id="results" class="results"></ul>
        <div id="hint" class="hint">Type to search e.g. “cottonmouth”, “timber rattlesnake”...</div>

        <div class="section-title" style="margin-top:16px; display:flex; align-items:center; justify-content:space-between;">
          <label><input id="nearby-toggle" type="checkbox"> Nearby (in view)</label>
        </div>
        <ul id="nearby" class="results nearby" style="display:none"></ul>
        <div id="nearby-hint" class="hint" style="display:none">Pan/zoom the map to update.</div>

        <div class="section-title">Sightings</div>
        <div style="display:flex; align-items:center; gap:8px; margin: 6px 2px;">
          <label><input id="sightings-toggle" type="checkbox"> Show sightings</label>
          <span id="sightings-count" class="hint" style="margin-left:auto;"></span>
        </div>
        <label style="display:flex; align-items:center; gap:8px; margin: 6px 2px;">
          <input id="heat-toggle" type="checkbox"> Historical heat (all records)
          <button id="heat-info-btn" title="What is this?" style="margin-left:auto; border:none; background:#334155; color:#e2e8f0; width:20px; height:20px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-weight:600; cursor:pointer;">i</button>
        </label>
        <div class="chips">
          <button class="chip active" data-days="all">All</button>
          <button class="chip" data-days="7">7d</button>
          <button class="chip" data-days="30">30d</button>
          <button class="chip" data-days="90">90d</button>
          <button class="chip" data-days="365">1y</button>
        </div>

        <div class="section-title">
          <span>Legend (selected species)</span>
          <button id="clear-selected" class="clear-btn" title="Clear all">Clear</button>
        </div>
        <ul id="legend" class="results selected-list"></ul>

        <div class="performance-section">
          <div class="section-title">Performance</div>
          <label>
            <input id="defer-ranges" type="checkbox" checked> Defer ranges while panning
          </label>
        </div>
      </aside>

      <main id="map"></main>
    </div>

    <div id="heat-info-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:center; justify-content:center;">
      <div style="background:#0f172a; color:#e2e8f0; max-width:720px; width:90%; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.4); overflow:hidden;">
        <div style="padding:14px 16px; border-bottom:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between;">
          <div style="font-weight:600;">Historical heat map</div>
          <button id="heat-info-close" style="border:none; background:transparent; color:#94a3b8; font-size:18px; cursor:pointer;">✕</button>
        </div>
        <div style="padding:16px; line-height:1.5; font-size:14px;">
          <p style="margin:0 0 10px 0;">The heat map is a smoothed density view of all occurrence points. Each record contributes a small radial kernel in screen pixels; overlapping kernels add up to form hotspots (an approximate kernel density estimate).</p>
          <pre style="white-space:pre-wrap; background:#111827; color:#e5e7eb; padding:12px; border-radius:6px; overflow:auto;">Value(x) ≈ Σ w_i · K(||x − x_i|| / r)
K: radial kernel (circular)
r: radius in pixels (we use ~18px + blur)
w_i: point weight (intensity)</pre>
          <ul style="margin:12px 0 0 18px; padding:0;">
            <li>All records across species are used; selection doesn’t change it.</li>
            <li>Weights are log-compressed; if a point has a count, it increases intensity.</li>
            <li>Downsampling may occur for performance on very large datasets.</li>
            <li>Because radius is in pixels, smoothing scales with zoom level.</li>
          </ul>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script type="module">
      // Always use dark theme
      document.documentElement.setAttribute('data-theme', 'dark');
      
      import { attachSearch, loadCommon, attachNearby, attachSelectedPanel, onSelectionChange, selectAllSpecies } from './main.js';
      import { initMap, setSelection, onMapMove, getViewBounds, getMap, setDeferRanges } from './map.js';
      import { initSightings, setSightingsVisible, setRecencyDays } from './sightings.js';

      await loadCommon();
      await initMap();

      initSightings(getMap());

      attachSearch();
      attachNearby({ onMove: onMapMove, getBounds: getViewBounds });
      attachSelectedPanel();
      onSelectionChange(setSelection);

      selectAllSpecies();

      const toggle = document.getElementById('sightings-toggle');
      toggle.addEventListener('change', () => setSightingsVisible(toggle.checked));



      const defer = document.getElementById('defer-ranges');
      defer.addEventListener('change', () => setDeferRanges(defer.checked));

      const heatToggle = document.getElementById('heat-toggle');
      heatToggle.addEventListener('change', async () => {
        const m = getMap();
        const { toggleHeatLayer } = await import('./map.js');
        toggleHeatLayer(heatToggle.checked, m);
      });

      const heatInfoBtn = document.getElementById('heat-info-btn');
      const heatInfoModal = document.getElementById('heat-info-modal');
      const heatInfoClose = document.getElementById('heat-info-close');
      if (heatInfoBtn && heatInfoModal && heatInfoClose) {
        heatInfoBtn.addEventListener('click', () => { heatInfoModal.style.display = 'flex'; });
        heatInfoClose.addEventListener('click', () => { heatInfoModal.style.display = 'none'; });
        heatInfoModal.addEventListener('click', (e) => { if (e.target === heatInfoModal) heatInfoModal.style.display = 'none'; });
      }


      // Chip active states
      for (const btn of document.querySelectorAll('.chip')) {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          const v = btn.dataset.days;
          setRecencyDays(v === 'all' ? null : parseInt(v, 10));
        });
      }
    </script>
  </body>
  </html>


